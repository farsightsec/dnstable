#!/bin/sh

DNSTQ=@abs_top_builddir@/src/dnstable_lookup
unset DNSTABLE_SETFILE
export DNSTABLE_FNAME=@abs_top_srcdir@/tests/test-dns.mtbl

#
# If test script is run with dnstable_lookup arguments, perform the lookup
# using JSON format for output.
# Otherwise, run all tests.
#
if [ -n "$*" ]; then
	$DNSTQ -j $*
	exit 0
fi

NL="
"

code=0

test_encode_bitmap() {
	local line result expected
	result="$(@abs_top_builddir@/tests/test-bitmaps -e "$*")"
	if [ $? -ne 0 ]; then
		echo test:bitmaps FAIL: $*
		code=1
		return
	fi

	while read line; do
		expected="${expected}${expected:+$NL}${line}"
	done

	if [ "$result" = "$expected" ]; then
		echo test:bitmaps PASS: $*
	else
		echo test:bitmaps FAIL: $*
		code=1
	fi
}


test_decode_bitmap() {
	local line result expected
	result="$(@abs_top_builddir@/tests/test-bitmaps -d $*)"
	if [ $? -ne 0 ]; then
		echo test:bitmaps FAIL: $*
		code=1
		return
	fi

	while read line; do
		expected="${expected}${expected:+$NL}${line}"
	done

	if [ "$result" = "$expected" ]; then
		echo test:bitmaps PASS: $*
	else
		echo test:bitmaps FAIL: $*
		code=1
	fi
}

test_decode_bitmap_fail() {
	local line result expected
	result="$(@abs_top_builddir@/tests/test-bitmaps -d $*)"
	if [ $? -ne 0 ]; then
		echo test_fails:bitmaps PASS: $*
	else
		echo test_fails:bitmaps FAIL: $*
		code=1
	fi
}


test_encode_bitmap 'A SOA' << EOF
bitmap: 000142
EOF

test_decode_bitmap 000142 << EOF
rrtype = 1 = A
rrtype = 6 = SOA
EOF

test_encode_bitmap 'A SOA TYPE65534' << EOF
bitmap: 000142ff200000000000000000000000000000000000000000000000000000000000000002
EOF

test_encode_bitmap 'TYPE260' << EOF
bitmap: 010108
EOF

test_decode_bitmap 000142ff200000000000000000000000000000000000000000000000000000000000000002 << EOF
rrtype = 1 = A
rrtype = 6 = SOA
rrtype = 65534 = (not assigned)
EOF

test_decode_bitmap_fail ff200000000000000000000000000000000000000000000000000000000000000002000142

test_decode_bitmap_fail 00014000

test_decode_bitmap_fail 0001400000

test_decode_bitmap_fail 000140000101

test_lookup() {
	local line result expected
	result="$($DNSTQ $*)"
	if [ $? -ne 0 ]; then
		echo test:lookup FAIL: $*
		code=1
		return
	fi

	while read line; do
		expected="${expected}${expected:+$NL}${line}"
	done

	if [ "$result" = "$expected" ]; then
		echo test:lookup PASS: $*
	else
		echo test:lookup FAIL: $*
		code=1
	fi
}

test_lookup_fails() {
	$DNSTQ $* 2>/dev/null 1>/dev/null
	if [ $? -ne 0 ]; then
		echo test_fails:lookup PASS: $*
	else
		echo test_fails:lookup FAIL: $*
		code=1
	fi
}

test_lookup -j rrset www.example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
EOF

test_lookup -j rrset www.example.com A << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
EOF

# same test again but with default dig presentation output
test_lookup rrset www.example.com A << EOF
;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
www.example.com. IN A 198.51.100.3
www.example.com. IN A 198.51.100.4
EOF

# test with bailiwick argument too
test_lookup -j rrset www.example.com A example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
EOF

# wrong bailiwick has no results
test_lookup -j rrset www.example.com A example.ORG << EOF
EOF

test_lookup -j rrset www.example.com AAAA << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
EOF

test_lookup -j rrset example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","bailiwick":"example.com.","rdata":["ns1.example.com.","ns2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","bailiwick":"example.com.","rdata":["hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","bailiwick":"example.com.","rdata":["10 mail.example.com.","20 mail2.example.com."]}
EOF

test_lookup -j rrset example.com NS << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","bailiwick":"example.com.","rdata":["ns1.example.com.","ns2.example.com."]}
EOF

test_lookup -j rrset example.com SOA << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","bailiwick":"example.com.","rdata":["hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"]}
EOF

test_lookup -j rrset example.com MX << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","bailiwick":"example.com.","rdata":["10 mail.example.com.","20 mail2.example.com."]}
EOF

test_lookup -j rrset _ldap._tcp.example.com SRV << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","bailiwick":"example.com.","rdata":["10 1 389 ldap.example.com."]}
EOF

# offset first five entries, left wildcard rrset lookup
test_lookup -j -O 5 rrset \*. << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","bailiwick":"example.com.","rdata":["10 1 389 ldap.example.com."]}
EOF

# offset first entry, right wildcard rrset lookup
test_lookup -j -O 1 rrset www.example.\* << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
EOF

# offset 1000 entries should have no result
test_lookup -j -O 1000 rrset www.example.\* << EOF
EOF

test_lookup -j rdata ip 198.51.100.3 << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","rdata":"198.51.100.3"}
EOF

test_lookup -j rdata ip 2001:db8::1 << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::1"}
EOF

# offset first entry, rdata ip subnet lookup
test_lookup -j -O 1 rdata ip 2001:db8::/0 << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::2"}
EOF

test_lookup -j rdata name ns1.example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns1.example.com."}
EOF

test_lookup -j rdata name \*.example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns1.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","rdata":"hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"}
EOF

test_lookup -j rdata name hidden-master.example.com SOA << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","rdata":"hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"}
EOF

test_lookup -j rdata name \*.example.com SOA << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","rdata":"hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"}
EOF

test_lookup -j rdata name ldap.example.com << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com."}
EOF

test_lookup -j rdata raw 00 SRV << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com."}
EOF

test_lookup -j rdata raw 00 MX << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
EOF

test_lookup -j -O 1 rdata raw 00 MX << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
EOF

test_lookup -j version << EOF
{"entry_type":"rrset","version":0}
{"entry_type":"rrset_name","version":0}
{"entry_type":"rdata","version":1}
{"entry_type":"rdata_name","version":1}
EOF

test_lookup -j version rdata << EOF
{"entry_type":"rdata","version":1}
EOF

test_lookup -j time_range << EOF
{"time_first":1522147408,"time_last":1522147408}
EOF

# -u unaggregated results mode requires DNSTABLE_SETFILE set
test_lookup_fails -j -u rdata raw 00 MX

#####################

# tests using set file pointing to mtbl files
export DNSTABLE_SETFILE=@abs_top_srcdir@/tests/test-dns.setfile
unset DNSTABLE_FNAME

test_lookup -j -u rdata raw 00 MX << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
EOF

test_lookup -j -O 2 -u rdata raw 00 MX << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
EOF

test_lookup -J -O 2 -u rdata raw 00 MX << EOF
{"count":1,"time_first":"2018-03-27T10:43:28Z","time_last":"2018-03-27T10:43:28Z","rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":"2018-03-27T10:43:28Z","time_last":"2018-03-27T10:43:28Z","rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
EOF

# test negative offset
test_lookup_fails -J -O -1 -u rdata raw 00 MX

# test no search query
test_lookup_fails -J -O 2

# test both -j and -J
test_lookup_fails -J -j -O 2 -u rdata raw 00 MX

# missing rrset arguments
test_lookup_fails rrset

# too many rrset arguments
test_lookup_fails rrset www.example.org A example.org thisisextra

# for rrset, slash / is not allowed in owner name
test_lookup_fails rrset www/example.org

# using unknown rdata subtype will fail
test_lookup_fails rdata junk foo

# using unknown query type will fail
test_lookup_fails junk foo bar

# rrset test using unknown RRTYPE mnemonic will fail
test_lookup_fails rrset www.example.org BOGUSTYPE example.org

# rdata raw test using unknown RRTYPE mnemonic will fail
test_lookup_fails rdata raw 00 BOGUSTYPE

#####################

# environment variable must be set
unset DNSTABLE_SETFILE
unset DNSTABLE_FNAME
test_lookup_fails rrset www.example.org A

#####################

# test for DNSTABLE_FNAME set to bogus filename
export DNSTABLE_FNAME=@abs_top_srcdir@/tests/this-does-not-exist
test_lookup_fails rrset www.example.org A

#####################

# test suppression of version entries with empty values
export DNSTABLE_FNAME=@abs_top_srcdir@/tests/empty-version.mtbl
test_lookup -j version << EOF
EOF

test_lookup -j time_range << EOF
EOF

# test suppression of version entries merged with empty-valued
# entries.
export DNSTABLE_SETFILE=@abs_top_srcdir@/tests/empty-version.setfile
unset DNSTABLE_FNAME
test_lookup -j version << EOF
EOF

test_lookup -j time_range << EOF
EOF

######################################################################

DUMP=@abs_top_builddir@/src/dnstable_dump
export TESTFILE=@abs_top_srcdir@/tests/test-dns.mtbl

test_dump() {
	local line result expected
	result="$($DUMP $*)"
	if [ $? -ne 0 ]; then
		echo test:dump FAIL: $*
		code=1
		return
	fi

	while read line; do
		expected="${expected}${expected:+$NL}${line}"
	done

	if [ "$result" = "$expected" ]; then
		echo test:dump PASS: $*
	else
		echo test:dump FAIL: $*
		code=1
	fi
}

test_dump_fails() {
	$DUMP $* 2>/dev/null 1>/dev/null
	if [ $? -ne 0 ]; then
		echo test_fails:dump PASS: $*
	else
		echo test_fails:dump FAIL: $*
		code=1
	fi
}

test_dump --rrset_full $TESTFILE << EOF
;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN NS ns1.example.com.
example.com. IN NS ns2.example.com.

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN SOA hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN MX 10 mail.example.com.
example.com. IN MX 20 mail2.example.com.

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
www.example.com. IN A 198.51.100.3
www.example.com. IN A 198.51.100.4

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
www.example.com. IN AAAA 2001:db8::1
www.example.com. IN AAAA 2001:db8::2

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
_ldap._tcp.example.com. IN SRV 10 1 389 ldap.example.com.
EOF

test_dump -j --rrset_full $TESTFILE << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","bailiwick":"example.com.","rdata":["ns1.example.com.","ns2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","bailiwick":"example.com.","rdata":["hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","bailiwick":"example.com.","rdata":["10 mail.example.com.","20 mail2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","bailiwick":"example.com.","rdata":["10 1 389 ldap.example.com."]}
EOF

test_dump --rdata_full $TESTFILE << EOF
_ldap._tcp.example.com. IN SRV 10 1 389 ldap.example.com.
example.com. IN MX 10 mail.example.com.
example.com. IN MX 20 mail2.example.com.
example.com. IN NS ns1.example.com.
example.com. IN NS ns2.example.com.
_ldap._tcp.example.com. IN SRV 10 1 389 ldap.example.com.
example.com. IN MX 10 mail.example.com.
example.com. IN MX 20 mail2.example.com.
example.com. IN SOA hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300
www.example.com. IN AAAA 2001:db8::1
www.example.com. IN AAAA 2001:db8::2
www.example.com. IN A 198.51.100.3
www.example.com. IN A 198.51.100.4
EOF

test_dump -j --rdata_full $TESTFILE << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns1.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com."}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","rdata":"hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::1"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::2"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","rdata":"198.51.100.3"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","rdata":"198.51.100.4"}
EOF

test_dump -j -R --rdata_full $TESTFILE << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com.","rdata_raw":"000a00010185046c646170076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com.","rdata_raw":"000a046d61696c076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com.","rdata_raw":"0014056d61696c32076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns1.example.com.","rdata_raw":"036e7331076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","rdata":"ns2.example.com.","rdata_raw":"036e7332076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","rdata":"10 1 389 ldap.example.com.","rdata_raw":"000a00010185046c646170076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"10 mail.example.com.","rdata_raw":"000a046d61696c076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","rdata":"20 mail2.example.com.","rdata_raw":"0014056d61696c32076578616d706c6503636f6d00"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","rdata":"hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300","rdata_raw":"0d68696464656e2d6d6173746572076578616d706c6503636f6d000a686f73746d6173746572076578616d706c6503636f6d007848bc3d0000001e0000001e000151800000012c"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::1","rdata_raw":"20010db8000000000000000000000001"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","rdata":"2001:db8::2","rdata_raw":"20010db8000000000000000000000002"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","rdata":"198.51.100.3","rdata_raw":"c6336403"}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","rdata":"198.51.100.4","rdata_raw":"c6336404"}
EOF

test_dump -r $TESTFILE << EOF
;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN NS ns1.example.com.
example.com. IN NS ns2.example.com.

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN SOA hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
example.com. IN MX 10 mail.example.com.
example.com. IN MX 20 mail2.example.com.

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
www.example.com. IN A 198.51.100.3
www.example.com. IN A 198.51.100.4

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
www.example.com. IN AAAA 2001:db8::1
www.example.com. IN AAAA 2001:db8::2

;;  bailiwick: example.com.
;;      count: 1
;; first seen: 2018-03-27 10:43:28 -0000
;;  last seen: 2018-03-27 10:43:28 -0000
_ldap._tcp.example.com. IN SRV 10 1 389 ldap.example.com.
EOF

test_dump -j -r $TESTFILE << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","bailiwick":"example.com.","rdata":["ns1.example.com.","ns2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","bailiwick":"example.com.","rdata":["hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","bailiwick":"example.com.","rdata":["10 mail.example.com.","20 mail2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","bailiwick":"example.com.","rdata":["10 1 389 ldap.example.com."]}
EOF

test_dump -r -j $TESTFILE << EOF
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"NS","bailiwick":"example.com.","rdata":["ns1.example.com.","ns2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"SOA","bailiwick":"example.com.","rdata":["hidden-master.example.com. hostmaster.example.com. 2018032701 30 30 86400 300"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"example.com.","rrtype":"MX","bailiwick":"example.com.","rdata":["10 mail.example.com.","20 mail2.example.com."]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"A","bailiwick":"example.com.","rdata":["198.51.100.3","198.51.100.4"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"www.example.com.","rrtype":"AAAA","bailiwick":"example.com.","rdata":["2001:db8::1","2001:db8::2"]}
{"count":1,"time_first":1522147408,"time_last":1522147408,"rrname":"_ldap._tcp.example.com.","rrtype":"SRV","bailiwick":"example.com.","rdata":["10 1 389 ldap.example.com."]}
EOF

test_dump_fails -j -R

test_dump_fails -j -R $TESTFILE

test_dump_fails --time_range

test_dump --time_range $TESTFILE << EOF
;; Earliest time_first: 2018-03-27 10:43:28 -0000
;; Latest time_last: 2018-03-27 10:43:28 -0000
EOF

test_dump --time_range -j $TESTFILE << EOF
{"time_first":1522147408,"time_last":1522147408}
EOF

test_dump_fails -R --time_range -j $TESTFILE

test_dump_fails --version

test_dump --version $TESTFILE << EOF
;; Version type rrset: 0

;; Version type rrset_name: 0

;; Version type rdata: 1

;; Version type rdata_name: 1
EOF

test_dump --version -j $TESTFILE << EOF
{"entry_type":"rrset","version":0}
{"entry_type":"rrset_name","version":0}
{"entry_type":"rdata","version":1}
{"entry_type":"rdata_name","version":1}
EOF

test_dump_fails -R --version -j $TESTFILE

test_dump --rrset_names $TESTFILE << EOF
www.example.com. RRtypes=[]  ;; rrset name fwd

_ldap._tcp.example.com. RRtypes=[]  ;; rrset name fwd

example.com. RRtypes=[]  ;; rrset name fwd
EOF

test_dump -j --rrset_names $TESTFILE << EOF
{"rrset_name":"www.example.com.","rrtypes":[]}
{"rrset_name":"_ldap._tcp.example.com.","rrtypes":[]}
{"rrset_name":"example.com.","rrtypes":[]}
EOF

test_dump --rdata_names $TESTFILE << EOF
ns1.example.com. RRtypes=[]  ;; rdata name rev

ns2.example.com. RRtypes=[]  ;; rdata name rev

ldap.example.com. RRtypes=[]  ;; rdata name rev

mail.example.com. RRtypes=[]  ;; rdata name rev

mail2.example.com. RRtypes=[]  ;; rdata name rev

hidden-master.example.com. RRtypes=[]  ;; rdata name rev
EOF

test_dump -j --rdata_names $TESTFILE << EOF
{"rdata_name":"ns1.example.com.","rrtypes":[]}
{"rdata_name":"ns2.example.com.","rrtypes":[]}
{"rdata_name":"ldap.example.com.","rrtypes":[]}
{"rdata_name":"mail.example.com.","rrtypes":[]}
{"rdata_name":"mail2.example.com.","rrtypes":[]}
{"rdata_name":"hidden-master.example.com.","rrtypes":[]}
EOF

test_dump_fails -R -j --rdata_names $TESTFILE

exit $code
